import React, { useState, useEffect } from 'react'
import {
  Box,
  Typography,
  Button,
  Grid,
  Paper,
  Tab,
  Tabs,
  Alert,
  CircularProgress,
  Fab,
  Tooltip,
} from '@mui/material'
import {
  Add as AddIcon,
  Upload as UploadIcon,
  Refresh as RefreshIcon,
  GetApp as ExportIcon,
} from '@mui/icons-material'
import {
  DatasetStats,
  DatasetCard,
  DatasetSearch,
  CreateDatasetModal,
  ImageUpload,
  ImageGallery,
} from '../../components/dataset'
import { useNotification } from '../../hooks/useNotification'
import { visionApi, Dataset, DatasetImage } from '../../services/api/visionApi'
import type { UploadProgress } from '../../types/common'

interface TabPanelProps {
  children?: React.ReactNode
  index: number
  value: number
}

function TabPanel(props: TabPanelProps) {
  const { children, value, index, ...other } = props
  return (
    <div
      role="tabpanel"
      hidden={value !== index}
      id={`dataset-tabpanel-${index}`}
      aria-labelledby={`dataset-tab-${index}`}
      {...other}
    >
      {value === index && <Box>{children}</Box>}
    </div>
  )
}

interface DatasetFilters {
  search: string
  status: string
  type: string
  labels: string[]
}

export function DatasetManagement() {
  const [datasets, setDatasets] = useState<Dataset[]>([])
  const [filteredDatasets, setFilteredDatasets] = useState<Dataset[]>([])
  const [selectedDatasetImages, setSelectedDatasetImages] = useState<DatasetImage[]>([])
  const [loading, setLoading] = useState(true)
  const [uploading, setUploading] = useState(false)
  const [activeTab, setActiveTab] = useState(0)
  const [createModalOpen, setCreateModalOpen] = useState(false)
  const [selectedDataset, setSelectedDataset] = useState<Dataset | null>(null)
  const [imagePage, setImagePage] = useState(1)
  const [totalImagePages, setTotalImagePages] = useState(1)
  const [filters, setFilters] = useState<DatasetFilters>({
    search: '',
    status: '',
    type: '',
    labels: [],
  })

  const { showNotification } = useNotification()

  // Load datasets on component mount
  useEffect(() => {
    loadDatasets()
  }, [])

  // Apply filters when datasets or filters change
  useEffect(() => {
    applyFilters()
  }, [datasets, filters])

  // Load selected dataset images when dataset changes
  useEffect(() => {
    if (selectedDataset && activeTab === 1) {
      loadDatasetImages(selectedDataset.id, imagePage)
    }
  }, [selectedDataset, activeTab, imagePage])

  const loadDatasets = async () => {
    try {
      setLoading(true)
      const datasetsData = await visionApi.getDatasets()
      setDatasets(datasetsData)
    } catch (error) {
      console.error('Failed to load datasets:', error)
      showNotification('„Éá„Éº„Çø„Çª„ÉÉ„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error')
    } finally {
      setLoading(false)
    }
  }

  const loadDatasetImages = async (datasetId: string, page: number = 1) => {
    try {
      const response = await visionApi.getDatasetImages(datasetId, page, 20)
      setSelectedDatasetImages(response.images)
      setTotalImagePages(response.total_pages)
    } catch (error) {
      console.error('Failed to load dataset images:', error)
      showNotification('ÁîªÂÉè„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error')
    }
  }

  const applyFilters = () => {
    let filtered = [...datasets]

    // Search filter
    if (filters.search) {
      const searchLower = filters.search.toLowerCase()
      filtered = filtered.filter(dataset =>
        dataset.name.toLowerCase().includes(searchLower) ||
        (dataset.description && dataset.description.toLowerCase().includes(searchLower))
      )
    }

    // Status filter
    if (filters.status) {
      filtered = filtered.filter(dataset => dataset.status === filters.status)
    }

    // Type filter
    if (filters.type) {
      filtered = filtered.filter(dataset => dataset.type === filters.type)
    }

    // Labels filter
    if (filters.labels.length > 0) {
      filtered = filtered.filter(dataset =>
        filters.labels.some(label => dataset.labels.includes(label))
      )
    }

    setFilteredDatasets(filtered)
  }

  const handleCreateDataset = async (datasetData: Omit<Dataset, 'id' | 'created_at' | 'updated_at' | 'image_count' | 'label_count' | 'size_bytes'>) => {
    try {
      const newDataset = await visionApi.createDataset(datasetData)
      setDatasets(prev => [newDataset, ...prev])
      showNotification(`„Éá„Éº„Çø„Çª„ÉÉ„Éà "${newDataset.name}" „Åå‰ΩúÊàê„Åï„Çå„Åæ„Åó„Åü`, 'success')
    } catch (error) {
      console.error('Failed to create dataset:', error)
      showNotification('„Éá„Éº„Çø„Çª„ÉÉ„Éà„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error')
      throw error
    }
  }

  const handleDatasetView = (datasetId: string) => {
    const dataset = datasets.find(d => d.id === datasetId)
    if (dataset) {
      setSelectedDataset(dataset)
      setActiveTab(1)
      setImagePage(1)
    }
  }

  const handleDatasetEdit = (datasetId: string) => {
    showNotification('„Éá„Éº„Çø„Çª„ÉÉ„ÉàÁ∑®ÈõÜÊ©üËÉΩ„ÅØ‰ªäÂæåÂÆüË£Ö‰∫àÂÆö„Åß„Åô', 'info')
  }

  const handleDatasetExport = async (datasetId: string) => {
    try {
      const dataset = datasets.find(d => d.id === datasetId)
      showNotification(`„Éá„Éº„Çø„Çª„ÉÉ„Éà "${dataset?.name}" „ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÇíÈñãÂßã„Åó„Åæ„Åó„Åü`, 'info')
      
      const result = await visionApi.exportDataset(datasetId, 'yolo')
      
      // Create download link
      const link = document.createElement('a')
      link.href = result.download_url
      link.download = `${dataset?.name}_export.zip`
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      
      showNotification('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü', 'success')
    } catch (error) {
      console.error('Failed to export dataset:', error)
      showNotification('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error')
    }
  }

  const handleDatasetDelete = async (datasetId: string) => {
    try {
      const dataset = datasets.find(d => d.id === datasetId)
      await visionApi.deleteDataset(datasetId)
      setDatasets(prev => prev.filter(d => d.id !== datasetId))
      
      if (selectedDataset?.id === datasetId) {
        setSelectedDataset(null)
        setActiveTab(0)
      }
      
      showNotification(`„Éá„Éº„Çø„Çª„ÉÉ„Éà "${dataset?.name}" „ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü`, 'success')
    } catch (error) {
      console.error('Failed to delete dataset:', error)
      showNotification('„Éá„Éº„Çø„Çª„ÉÉ„Éà„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error')
    }
  }

  const handleImageUpload = async (files: File[], onProgress: (progress: UploadProgress) => void) => {
    if (!selectedDataset) {
      throw new Error('No dataset selected')
    }

    try {
      setUploading(true)
      const result = await visionApi.uploadImages(selectedDataset.id, files, onProgress)
      
      // Refresh dataset info and images
      await loadDatasets()
      await loadDatasetImages(selectedDataset.id, imagePage)
      
      showNotification(`${result.uploaded} Êûö„ÅÆÁîªÂÉè„Åå„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åæ„Åó„Åü`, 'success')
      
      if (result.failed > 0) {
        showNotification(`${result.failed} Êûö„ÅÆÁîªÂÉè„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü`, 'warning')
      }
    } catch (error) {
      console.error('Failed to upload images:', error)
      showNotification('ÁîªÂÉè„ÅÆ„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error')
      throw error
    } finally {
      setUploading(false)
    }
  }

  const handleImageView = (imageId: string) => {
    showNotification('ÁîªÂÉèË©≥Á¥∞Ë°®Á§∫Ê©üËÉΩ„ÅØ‰ªäÂæåÂÆüË£Ö‰∫àÂÆö„Åß„Åô', 'info')
  }

  const handleImageEdit = (imageId: string) => {
    showNotification('ÁîªÂÉè„É©„Éô„É™„É≥„Ç∞Ê©üËÉΩ„ÅØ‰ªäÂæåÂÆüË£Ö‰∫àÂÆö„Åß„Åô', 'info')
  }

  const handleImageDelete = async (imageId: string) => {
    if (!selectedDataset) return

    try {
      await visionApi.deleteImage(selectedDataset.id, imageId)
      await loadDatasetImages(selectedDataset.id, imagePage)
      showNotification('ÁîªÂÉè„ÅåÂâäÈô§„Åï„Çå„Åæ„Åó„Åü', 'success')
    } catch (error) {
      console.error('Failed to delete image:', error)
      showNotification('ÁîªÂÉè„ÅÆÂâäÈô§„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error')
    }
  }

  const handleTabChange = (event: React.SyntheticEvent, newValue: number) => {
    setActiveTab(newValue)
  }

  const handleRefresh = () => {
    loadDatasets()
    if (selectedDataset && activeTab === 1) {
      loadDatasetImages(selectedDataset.id, imagePage)
    }
  }

  return (
    <Box sx={{ height: '100%', display: 'flex', flexDirection: 'column' }}>
      {/* Header */}
      <Box display="flex" justifyContent="space-between" alignItems="center" mb={3}>
        <Typography variant="h4" component="h1" fontWeight="bold">
          üìÅ „Éá„Éº„Çø„Çª„ÉÉ„ÉàÁÆ°ÁêÜ
        </Typography>
        <Box display="flex" gap={2}>
          <Button
            variant="outlined"
            startIcon={<RefreshIcon />}
            onClick={handleRefresh}
            disabled={loading}
          >
            Êõ¥Êñ∞
          </Button>
          <Button
            variant="contained"
            startIcon={<AddIcon />}
            onClick={() => setCreateModalOpen(true)}
          >
            Êñ∞Ë¶è„Éá„Éº„Çø„Çª„ÉÉ„Éà
          </Button>
        </Box>
      </Box>

      {/* Tabs */}
      <Box sx={{ borderBottom: 1, borderColor: 'divider', mb: 3 }}>
        <Tabs value={activeTab} onChange={handleTabChange}>
          <Tab label="„Éá„Éº„Çø„Çª„ÉÉ„Éà‰∏ÄË¶ß" />
          <Tab 
            label={selectedDataset ? `ÁîªÂÉèÁÆ°ÁêÜ: ${selectedDataset.name}` : 'ÁîªÂÉèÁÆ°ÁêÜ'} 
            disabled={!selectedDataset}
          />
        </Tabs>
      </Box>

      {/* Tab Content */}
      <Box sx={{ flexGrow: 1, overflow: 'auto' }}>
        {/* Dataset List Tab */}
        <TabPanel value={activeTab} index={0}>
          <Box display="flex" flexDirection="column" gap={3}>
            {/* Statistics */}
            <DatasetStats datasets={datasets} loading={loading} />

            {/* Search and Filters */}
            <Paper elevation={1} sx={{ p: 3 }}>
              <DatasetSearch
                datasets={datasets}
                filters={filters}
                onFiltersChange={setFilters}
              />
            </Paper>

            {/* Dataset Grid */}
            {loading ? (
              <Box display="flex" justifyContent="center" py={4}>
                <CircularProgress />
              </Box>
            ) : filteredDatasets.length > 0 ? (
              <Grid container spacing={3}>
                {filteredDatasets.map((dataset) => (
                  <Grid item xs={12} sm={6} md={4} lg={3} key={dataset.id}>
                    <DatasetCard
                      dataset={dataset}
                      onView={handleDatasetView}
                      onEdit={handleDatasetEdit}
                      onExport={handleDatasetExport}
                      onDelete={handleDatasetDelete}
                    />
                  </Grid>
                ))}
              </Grid>
            ) : (
              <Alert severity="info">
                <Typography variant="body1">
                  {filters.search || filters.status || filters.type || filters.labels.length > 0
                    ? '„Éï„Ç£„É´„ÇøÊù°‰ª∂„Å´‰∏ÄËá¥„Åô„Çã„Éá„Éº„Çø„Çª„ÉÉ„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì'
                    : '„Éá„Éº„Çø„Çª„ÉÉ„Éà„Åå„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÊñ∞„Åó„ÅÑ„Éá„Éº„Çø„Çª„ÉÉ„Éà„Çí‰ΩúÊàê„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
                  }
                </Typography>
              </Alert>
            )}
          </Box>
        </TabPanel>

        {/* Image Management Tab */}
        <TabPanel value={activeTab} index={1}>
          {selectedDataset ? (
            <Box display="flex" flexDirection="column" gap={3}>
              {/* Dataset Info */}
              <Paper elevation={1} sx={{ p: 3 }}>
                <Box display="flex" justifyContent="space-between" alignItems="flex-start">
                  <Box>
                    <Typography variant="h5" gutterBottom>
                      {selectedDataset.name}
                    </Typography>
                    <Typography variant="body1" color="text.secondary" gutterBottom>
                      {selectedDataset.description}
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                      {selectedDataset.image_count} Êûö„ÅÆÁîªÂÉè ‚Ä¢ {selectedDataset.label_count} „É©„Éô„É´
                    </Typography>
                  </Box>
                  <Button
                    variant="outlined"
                    onClick={() => setActiveTab(0)}
                  >
                    „Éá„Éº„Çø„Çª„ÉÉ„Éà‰∏ÄË¶ß„Å´Êàª„Çã
                  </Button>
                </Box>
              </Paper>

              {/* Image Upload */}
              <Paper elevation={1} sx={{ p: 3 }}>
                <Typography variant="h6" gutterBottom>
                  ÁîªÂÉè„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ
                </Typography>
                <ImageUpload
                  datasetId={selectedDataset.id}
                  onUpload={handleImageUpload}
                  disabled={uploading}
                />
              </Paper>

              {/* Image Gallery */}
              <Paper elevation={1} sx={{ p: 3 }}>
                <Typography variant="h6" gutterBottom>
                  ÁîªÂÉè‰∏ÄË¶ß
                </Typography>
                <ImageGallery
                  images={selectedDatasetImages}
                  page={imagePage}
                  totalPages={totalImagePages}
                  onPageChange={setImagePage}
                  onImageView={handleImageView}
                  onImageEdit={handleImageEdit}
                  onImageDelete={handleImageDelete}
                  selectable={true}
                />
              </Paper>
            </Box>
          ) : (
            <Alert severity="info">
              „Éá„Éº„Çø„Çª„ÉÉ„Éà„ÇíÈÅ∏Êäû„Åó„Å¶„Åè„Å†„Åï„ÅÑ
            </Alert>
          )}
        </TabPanel>
      </Box>

      {/* Floating Action Button */}
      {activeTab === 0 && (
        <Fab
          color="primary"
          sx={{ position: 'fixed', bottom: 24, right: 24 }}
          onClick={() => setCreateModalOpen(true)}
        >
          <Tooltip title="Êñ∞Ë¶è„Éá„Éº„Çø„Çª„ÉÉ„Éà‰ΩúÊàê">
            <AddIcon />
          </Tooltip>
        </Fab>
      )}

      {/* Create Dataset Modal */}
      <CreateDatasetModal
        open={createModalOpen}
        onClose={() => setCreateModalOpen(false)}
        onSubmit={handleCreateDataset}
        loading={uploading}
      />
    </Box>
  )
}